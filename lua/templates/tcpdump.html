{{ --$def with (device, running, bytes_sent) }}<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Download device traffic {{= device }}</title>
        <script type="text/javascript" src="/spin/js/jquery-3.1.1.min.js" ></script>
        <script type="text/javascript" src="/spin/js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
        <link type="text/css" href="/spin/js/jquery-ui-1.12.1.custom/jquery-ui.theme.css" rel="stylesheet">
        <link type="text/css" href="/spin/js/jquery-ui-1.12.1.custom/jquery-ui.css" rel="stylesheet">
        </script>
    </head>

    <body onunload="stop()">
            <div id="bytes_sent_status"></div>
    <script type="text/javascript" >
        var reloader;

        function load_status() {
            //alert("load!");
            //$("bytes_sent_status").load("/spin/tcpdump_status?device={{=device}}", function (data) { $(this).html(data); console.log("status set to " + data); });
            $("#bytes_sent_status").load("/spin/tcpdump_status?device={{=device}}");
        }
        
        function stop() {
            clearInterval(reloader);
            $.get("/spin/tcpdump_stop?device={{=device}}").done(function(){window.close();});
        }

        function start() {
            reloader = setInterval(function() {
                load_status();
            }, 1000);
        }
        
        $(window).on('beforeunload', function(){
            // Call for stop if the user hasn't, we do not
            // want runaway tcpdump processes
            $.ajax({
            async: false,
            cache: false,
            url: "/spin/tcpdump_stop?device={{=device}}"
            });
            return void(0);
        });
        
        load_status();
    </script>

    </body>

</html>
